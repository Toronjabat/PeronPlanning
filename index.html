<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PeronPlanning</title>
  <style>
    body { font-family: Arial,sans-serif; background:#f0f0f0; display:flex; justify-content:center; padding:20px; }
    .container { background:#fff; padding:20px; border-radius:12px; width:650px; box-shadow:0 3px 10px rgba(0,0,0,0.2); }
    h1 { text-align:center; margin-bottom:20px; }
    .player { margin:15px 0; text-align:center; }
    .player h3 { margin-bottom:10px; }
    .cards { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; }
    .card { width:60px; height:80px; perspective:1000px; cursor:pointer; }
    .card-inner { width:100%; height:100%; text-align:center; border-radius:10px; transition:transform 0.6s; transform-style:preserve-3d; }
    .card.selected .card-inner { transform:rotateY(0deg); }
    .card.flip .card-inner { transform:rotateY(180deg); }
    .card-front, .card-back { position:absolute; width:60px; height:80px; backface-visibility:hidden; border-radius:10px; display:flex; justify-content:center; align-items:center; font-weight:bold; font-size:1.2em; }
    .card-front { background:#eee; }
    .card-front.selected { background:#4caf50; color:#fff; }
    .card-back { background:#2196f3; color:#fff; transform:rotateY(180deg); }
    #showResults { display:block; margin:20px auto; padding:12px 25px; font-size:1em; cursor:pointer; }
    #result { text-align:center; margin-top:20px; font-weight:bold; }
    #logoutBtn { display:block; margin:10px auto; padding:5px 15px; cursor:pointer; }
    #usersList { text-align:center; margin-bottom:20px; }
    #loginDiv { text-align:center; margin-top:50px; }
    #loginDiv input { padding:5px; margin-right:5px; }
    #loginDiv button { padding:5px 10px; }
    #loginMsg { color:red; margin-top:10px; }
  </style>
</head>
<body>
<div id="gameContainer"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const container = document.getElementById("gameContainer");
  let username = localStorage.getItem("username");

  if (!username) {
    // FORMULARIO DE LOGIN
    const loginDiv = document.createElement("div");
    loginDiv.id = "loginDiv";
    loginDiv.innerHTML = `
      <h1>Login</h1>
      <input type="text" id="loginUser" placeholder="Usuario">
      <button id="loginBtn">Ingresar</button>
      <div id="loginMsg"></div>
    `;
    container.appendChild(loginDiv);

    document.getElementById("loginBtn").addEventListener("click", async () => {
      const input = document.getElementById("loginUser").value.trim();
      const msgDiv = document.getElementById("loginMsg");
      if (!input) { msgDiv.textContent = "Ingrese un usuario válido"; return; }

      try {
        const res = await fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: input })
        });
        const data = await res.json();
        if (data.success) {
          localStorage.setItem("username", data.username);
          location.reload();
        } else {
          msgDiv.textContent = data.message || "Error en login";
        }
      } catch {
        msgDiv.textContent = "Error de conexión al servidor";
      }
    });
  } else {
    // POKER PLANNING
    const socket = io();

    // Después de crear el socket
socket.emit("register-user", username);

    container.innerHTML = `
      <div class="container">
        <h1>PeronPlanning - ${username}</h1>
        <div id="usersList"><strong>Usuarios conectados:</strong> ...</div>
        <div id="playersContainer"></div>
        <button id="showResults">Revelar Resultados</button>
        <button id="logoutBtn">Cerrar sesión</button>
        <div id="result"></div>
      </div>
    `;
    const usersListDiv = document.getElementById("usersList");
    const playersContainer = document.getElementById("playersContainer");
    const resultDiv = document.getElementById("result");

    // Socket.io en tiempo real
    socket.on("users-list", (users) => {
      usersListDiv.innerHTML = `<strong>Usuarios conectados:</strong> ${users.join(", ")}`;
    });
    socket.on("new-user", (newUser) => {
      const current = usersListDiv.textContent.split(":")[1]?.trim() || "";
      usersListDiv.innerHTML = `<strong>Usuarios conectados:</strong> ${current ? current + ", " + newUser : newUser}`;
    });
    socket.on("user-left", (leftUser) => {
      const current = usersListDiv.textContent.split(":")[1]?.trim().split(", ") || [];
      const updated = current.filter(u => u !== leftUser);
      usersListDiv.innerHTML = `<strong>Usuarios conectados:</strong> ${updated.join(", ")}`;
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        await fetch("/logout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username })
        });
      } catch(err) {
        console.error("Error al desconectarse", err);
      }
      localStorage.removeItem("username");
      location.reload();
    });

    // Datos del juego
    const values = [1,2,3,5,8,"?"];
    const players = [""];
    const votes = {};

    // Crear interfaz por jugador
    players.forEach(player => {
      const div = document.createElement("div");
      div.className = "player";
      const title = document.createElement("h3");
      title.textContent = player;
      div.appendChild(title);

      const cardContainer = document.createElement("div");
      cardContainer.className = "cards";

      values.forEach(value => {
        const card = document.createElement("div");
        card.className = "card";

        const inner = document.createElement("div");
        inner.className = "card-inner";

        const front = document.createElement("div");
        front.className = "card-front";
        front.textContent = value;

        const back = document.createElement("div");
        back.className = "card-back";
        back.textContent = value;

        inner.appendChild(front);
        inner.appendChild(back);
        card.appendChild(inner);

        card.addEventListener("click", () => {
          cardContainer.querySelectorAll(".card").forEach(c => c.querySelector(".card-front").classList.remove("selected"));
          front.classList.add("selected");
          votes[player] = value;
        });

        cardContainer.appendChild(card);
      });

      div.appendChild(cardContainer);
      playersContainer.appendChild(div);
    });

    // Revelar resultados
    document.getElementById("showResults").addEventListener("click", () => {
      let total=0, count=0;
      const voteList=[];
      players.forEach(player => {
        const v = votes[player];
        voteList.push(`${player}: ${v !== undefined ? v : "No votó"}`);
        if (typeof v === "number") { total += v; count++; }

        const playerDiv = Array.from(playersContainer.querySelectorAll(".player"))
          .find(p => p.querySelector("h3").textContent === player);
        playerDiv.querySelectorAll(".card").forEach(c => {
          if (c.querySelector(".card-front").textContent == v) c.classList.add("flip");
        });
      });
      const average = count ? (total/count).toFixed(2) : "N/A";
      resultDiv.innerHTML = `<strong>Promedio:</strong> ${average}<br>${voteList.join("<br>")}`;
    });
  }
</script>
</body>
</html>
